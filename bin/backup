#!/bin/bash

OBNAM_LOG=$HOME/log/obnam.log.last

main() {

  local checksum=$HOME/checksum/checksum
  local config=$HOME/.config/obnam/local.conf
  local obnam_opts=$1

  # make sure we're using the right gpg key
  keychain --stop others --noask --agents gpg 2> $OBNAM_LOG
  . ~/.keychain/`hostname`-sh-gpg

  # some random data to verify against
  dd if=/dev/urandom of=$checksum bs=1M count=10 2> /dev/null

  # backup, verify, forget
  obnam --config=$config $obnam_opts backup && \
  obnam --config=$config $obnam_opts verify `dirname $checksum`
  obnam --config=$config $obnam_opts forget

}

GNUPGHOME=$HOME/.gnupg main $@ > $OBNAM_LOG
